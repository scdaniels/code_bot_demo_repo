---
#  Example patching a RHEL VM Guest on vmware
#
#  Outline:
#    1.  Issue snapshot on VMware infrastructure
#    2.  Patch RHEL Guest
#    3.  Reboot RHEL Guest
#    4.  Wait for reboot to complete
#
- name: Patch an RHEL vmware guest
  hosts: rhel-guests
  remote_user: ansibleop
  become: true
  vars_files:
    - vars/secret.yml

  tasks:
    - name: Quiesce and take a snapshot
      delegate_to: localhost
      community.vmware.vmware_guest_snapshot:
        hostname: "{{ inventory_hostname }}"
        username: "{{ vcenter_svc_user }}"
        password: "{{ vcenter_svc_pw }}"
        datacenter: DC
        folder: /myfolder
        name: "{{ inventory_hostname }}"
        state: present
        quiesce: true
        snapshot_name: 2018Q4-Patch-Snapshot
        description: Snapshot for Q4 Patching

    - name: Install the latest patches allowed by the Content View
      register: yum_update
      ansible.builtin.yum:
        name: "*"
        state: latest
    # exclude: kernel*

    - name: Restart the system
      async: 1
      poll: 0
      ignore_errors: true
      when: yum_update.changed
      ansible.builtin.shell: sleep 2 && shutdown -r now "Reboot post patching via Ansible"

    - name: Wait for the server to restart
      become: false
      delegate_to: localhost
      when: yum_update.changed
      ansible.builtin.wait_for:
        host: "{{ inventory_hostname }}"
        port: 22
        state: started
        delay: 25
        timeout: 200

    - name: Invoke Ping module on the host to verify that it is up
      ansible.builtin.ping:
